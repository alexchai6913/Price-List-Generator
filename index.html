<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricelist PDF Export - Grid Layout</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PapaParse for CSV/TSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Google Fonts: Exo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <style>
        /* Base typography */
        body {
            font-family: 'Exo', sans-serif;
            background-color: #f1f5f9;
        }

        /* Force exact colors for printing */
        * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* --- GRID SYSTEM SETUP --- */

        /* 1. Horizontal Layout: 3 Columns 
           Col 1: Name (1fr)
           Col 2: Badge (Auto - adapts to widest badge)
           Col 3: Price (Min-content) 
        */
        /* 1. Horizontal Layout: 3 Columns */
        .grid-layout-horizontal {
            display: grid;

            grid-template-columns: 1fr 100px 100px;

            column-gap: 1rem;
        }

        /* 2. Stacked Layout: 2 Columns 
           Col 1: Name (1fr)
           Col 2: Price + Badge Stacked (Min-content)
        */
        .grid-layout-stacked {
            display: grid;
            grid-template-columns: 1fr max(102px, max-content);
            column-gap: 1rem;
        }

        /* 3. The Row Item (Subgrid) 
           This tells the LI to use the columns defined in the UL parent
        */
        .grid-row {
            display: grid;
            grid-column: 1 / -1;
            /* Span all columns of parent */
            grid-template-columns: subgrid;
            /* Align to parent grid lines */
            align-items: center;
        }

        /* Print Specifics */
        @media print {
            @page {
                size: A4 portrait;
                margin: 5cm 1.5 2cm 1.5cm;
            }

            body {
                background-color: white;
                margin: 0;
                padding: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-container {
                width: 20cm !important;
                max-width: 20cm !important;
                margin: 0 auto !important;
                padding: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }

            /* Ensure grid doesn't break awkwardly */
            .break-inside-avoid {
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }

        input[type=range] {
            height: 4px;
            border-radius: 5px;
            background: #cbd5e1;
            outline: none;
        }
    </style>
</head>

<body class="text-gray-800 antialiased">

    <!-- UI Controls -->
    <div
        class="no-print max-w-[20cm] mx-auto p-5 mt-6 bg-white rounded-xl shadow-lg border border-gray-200 mb-8 space-y-4">
        <div class="flex justify-between items-center border-b border-gray-100 pb-4">
            <div>
                <h1 class="text-xl font-bold text-gray-900">Pricelist Designer</h1>
                <p class="text-sm text-gray-500">Specialized for DIY PC Parts</p>
            </div>
            <button onclick="window.print()"
                class="bg-[#004bc8] hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg shadow transition-colors flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 6 2 18 2 18 9"></polyline>
                    <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                    <rect x="6" y="14" width="12" height="8"></rect>
                </svg>
                Print PDF
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- 1. NEW: URL Input Section (Spans full width) -->
            <!-- 1. URL Input Section -->
            <div class="col-span-1 md:col-span-2 lg:col-span-4 border-b border-gray-100 pb-4 mb-2">
                <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Google Sheets Link</label>
                <div class="flex flex-col md:flex-row gap-2 mt-1">
                    <!-- Input Field -->
                    <input type="text" id="sheetUrl"
                        placeholder="Paste link here e.g., https://docs.google.com/spreadsheets/d/..."
                        class="flex-1 bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">

                    <!-- Action Buttons -->
                    <div class="flex gap-2">
                        <button id="loadBtn"
                            class="bg-[#004bc8] hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg text-sm transition-colors whitespace-nowrap">
                            Load Data
                        </button>

                        <a href="https://docs.google.com/spreadsheets/d/1pSyZuJ3qkhD68O7rkMi4wmNCKk2Hk6eKAFlJfM9FdwE/edit?usp=sharing"
                            target="_blank"
                            class="bg-white hover:bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition-colors border border-gray-300 flex items-center gap-1 whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            View Template
                        </a>
                    </div>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">Make sure the Sheet is set to "Anyone with the link can view"
                </p>
            </div>

            <!-- Toggle Regex -->
            <div class="flex flex-col gap-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Features</span>
                <label
                    class="flex items-center cursor-pointer gap-2 bg-gray-50 p-2 rounded-lg border border-gray-200 hover:bg-gray-100">
                    <input type="checkbox" id="regexToggle"
                        class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                    <span class="text-sm font-semibold">Extract Specs as Badges</span>
                </label>
            </div>

            <!-- Layout Selector -->
            <div class="flex flex-col gap-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Price Layout</span>
                <select id="layoutSelect"
                    class="bg-gray-50 border border-gray-200 text-gray-800 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 font-semibold">
                    <option value="horizontal">Horizontal (Grid Aligned)</option>
                    <option value="stacked">Stacked (Vertical Price)</option>
                </select>
            </div>

            <!-- Font Size Slider -->
            <div class="flex flex-col gap-2 lg:col-span-2">
                <div class="flex justify-between">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">Product Name Size</span>
                    <span id="fontSizeDisplay"
                        class="text-xs font-bold text-blue-600 bg-blue-50 px-2 rounded">14.5px</span>
                </div>
                <input type="range" id="fontSizeSlider" min="10" max="24" step="0.5" value="14.5"
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="no-print flex flex-col items-center justify-center py-20 gap-3">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="font-bold text-gray-500">Loading Pricelist...</p>
    </div>

    <!-- Printable Area -->
    <div id="print-area"
        class="print-container w-full max-w-[20cm] mx-auto bg-white p-6 shadow-sm border border-gray-200 hidden">
        <div id="product-container"></div>
    </div>

    <script>
        let currentApiUrl = "https://docs.google.com/spreadsheets/d/1pSyZuJ3qkhD68O7rkMi4wmNCKk2Hk6eKAFlJfM9FdwE/export?format=tsv&gid=0";
        const FALLBACK_DATA = `Product	SRP	Promo	Brand
INTEL Core i3-12100 3.3~4.3GHz/12MB Cache/4-Cores 8-Threads	 489 	 429 	Processor (INTEL)
ASUS PRIME B760M-A WIFI D4	 790 	 579 	Mainboard (INTEL)`;

        let state = {
            data: [],
            regexEnabled: true, // Default to true now
            layout: 'horizontal',
            fontSize: 14.5
        };

        document.addEventListener("DOMContentLoaded", () => {
            fetchData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('regexToggle').addEventListener('change', (e) => {
                state.regexEnabled = e.target.checked;
                render();
            });
            document.getElementById('layoutSelect').addEventListener('change', (e) => {
                state.layout = e.target.value;
                render();
            });
            const slider = document.getElementById('fontSizeSlider');
            const display = document.getElementById('fontSizeDisplay');
            slider.addEventListener('input', (e) => {
                state.fontSize = e.target.value;
                display.innerText = `${state.fontSize}px`;
                render();
            });
            // NEW: Load Button Listener
            document.getElementById('loadBtn').addEventListener('click', () => {
                const inputUrl = document.getElementById('sheetUrl').value.trim();
                if (!inputUrl) return alert("Please paste a URL first.");

                const newApiUrl = convertToExportUrl(inputUrl);
                if (newApiUrl) {
                    currentApiUrl = newApiUrl;
                    document.getElementById('loading').classList.remove('hidden'); // Show loader
                    document.getElementById('print-area').classList.add('hidden'); // Hide content
                    fetchData(); // Reload
                } else {
                    alert("Invalid Google Sheets URL. It must contain the Spreadsheet ID.");
                }
            });
        }

        async function fetchData() {
            try {
                // CHANGE: API_URL -> currentApiUrl
                const response = await fetch(currentApiUrl);
                if (!response.ok) throw new Error("Network error");
                parseData(await response.text());
            } catch (error) {
                alert("Failed to load. Check if the sheet is Public.");
                parseData(FALLBACK_DATA);
            }
        }

        function parseData(rawData) {
            Papa.parse(rawData, {
                delimiter: "\t",
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    state.data = results.data.map(row => {
                        const getVal = (key) => Object.values(row)[Object.keys(row).findIndex(k => k.trim() === key)] || "";
                        return {
                            product: getVal("Product").trim(),
                            srp: parseFloat(String(getVal("SRP")).replace(/,/g, '').trim()) || 0,
                            promo: parseFloat(String(getVal("Promo")).replace(/,/g, '').trim()) || 0,
                            category: getVal("Brand").trim() || "Uncategorized"
                        };
                    }).filter(item => item.product);

                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('print-area').classList.remove('hidden');

                    // Set default checkbox state
                    document.getElementById('regexToggle').checked = state.regexEnabled;
                    render();
                }
            });
        }

        /**
         * Updated Regex Function
         * 1. Matches comprehensive specs based on your list.
         * 2. Returns original name UNTOUCHED.
         */
        function extractFeatures(fullName, enableRegex) {
            // 1. If Regex is off, return no badges, but keep the full name
            if (!enableRegex) return { name: fullName, features: [] };

            // 2. The Comprehensive Regex
            // We concatenate .source to build one large regex while keeping it readable
            const featureRegex = new RegExp(
                // Group A: GHz Frequency (Handes ranges like 3.6~5.2GHz, 3.7-4.6GHz)
                /(?:\b\d+(?:\.\d+)?\s*(?:[~-]\s*\d+(?:\.\d+)?)?\s*GHz\b)|/.source +

                // Group B: Capacity/Power/Bus/Size (12GB, 650W, 128Bit, 53mm)
                /(?:\b\d+(?:GB|TB|MB|W|Bit|mm)\b)|/.source +

                // Group C: Tech Specs & Form Factors
                /(?:\b(?:DDR\d|D[45]|GDDR\d+X?|E?ATX|mATX|ITX|SFX|WIFI[67E]?|ARGB|RGB|AIO|OC|Type-C|Gen\d+|LGA\d+|AM[45])\b)|/.source +

                // Group D: PSU Ratings
                /(?:80PLUS\s*(?:White|Bronze|Silver|Gold|Platinum|Titanium)?)|/.source +

                // Group E: Colors
                /(?:\b(?:White|Black|Silver|Red|Grey)\b)|/.source +

                // Group F: Cores/Threads/Heatpipes (e.g., 4-Cores, 6-Heat Pipe)
                /(?:\b\d+-(?:Cores|Threads|Heat\s*Pipe)\b)/.source,

                "gi" // <--- Flags are here. Ensure there are no spaces (just "gi")
            );

            // 3. Extract matches
            const matches = fullName.match(featureRegex) || [];

            // 4. Clean up matches (Uppercase, Remove duplicates, Remove internal spaces)
            const uniqueFeatures = [...new Set(
                matches.map(m => m.replace(/\s+/g, '').trim().toUpperCase())
            )];

            // 5. Return Original Name + Extracted Features
            return { name: fullName, features: uniqueFeatures };
        }

        /**
 * Converts a standard Google Sheets URL to a TSV Export URL
 * Handles: /edit#gid=... or just the ID
 */
        function convertToExportUrl(url) {
            // 1. Extract Spreadsheet ID (matches characters between /d/ and /)
            const idMatch = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (!idMatch) return null;
            const sheetId = idMatch[1];

            // 2. Extract GID (Sheet Tab ID). Defaults to '0' (first tab) if not found.
            // Matches "gid=123" in query params or hash
            const gidMatch = url.match(/[?#&]gid=([0-9]+)/);
            const gid = gidMatch ? gidMatch[1] : '0';

            return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=tsv&gid=${gid}`;
        }

        function render() {
            const container = document.getElementById('product-container');
            container.innerHTML = '';

            const grouped = state.data.reduce((acc, item) => {
                if (!acc[item.category]) acc[item.category] = [];
                acc[item.category].push(item);
                return acc;
            }, {});

            const sortedCategories = Object.keys(grouped).sort();

            sortedCategories.forEach(category => {
                const items = grouped[category].sort((a, b) => a.product.localeCompare(b.product));

                // Category Header
                const catHeader = document.createElement('h2');
                catHeader.className = "text-[20px] font-[800] text-[#5611AF] uppercase mt-6 mb-2 break-inside-avoid tracking-wide";
                catHeader.innerText = category;
                container.appendChild(catHeader);

                // Main List Container (The Grid Parent)
                const list = document.createElement('ul');
                list.className = state.layout === 'horizontal'
                    ? "grid-layout-horizontal w-full"
                    : "grid-layout-stacked w-full";

                items.forEach(item => {
                    const { name, features } = extractFeatures(item.product, state.regexEnabled);
                    const saveAmount = Math.ceil(item.srp - item.promo);

                    const li = document.createElement('li');
                    li.className = "grid-row border-b border-gray-200 py-3 break-inside-avoid";

                    // Feature Badges
                    // Limit to 4 badges max to prevent cluttering since we keep the full name
                    const displayFeatures = features.slice(0, 5);

                    const featuresHtml = displayFeatures.length > 0 ?
                        `<div class="mt-1 flex flex-wrap gap-1">` +
                        displayFeatures.map(f => `<span class="bg-gray-100 text-gray-600 border border-gray-200 px-1.5 py-0.5 text-[10px] rounded font-bold uppercase tracking-tight">${f}</span>`).join('') +
                        `</div>` : '';

                    // 1. Name Column (Now contains FULL Name + Badges below it)
                    const nameCol = `
                        <div class="flex flex-col justify-center">
                            <h3 class="font-[700] text-[#222] leading-[1.2]" style="font-size: ${state.fontSize}px">${name}</h3>
                            ${featuresHtml}
                        </div>
                    `;

                    // Badge HTML (Common)
                    const saveBadgeHtml = saveAmount > 0
                        ? `<div class="bg-[#8b3dff] text-white text-[13px] font-bold px-3 py-[4px] rounded shadow-sm whitespace-nowrap leading-none inline-block text-center w-full">Save RM${saveAmount.toLocaleString('en-MY')}</div>`
                        : '';

                    let remainingCols = '';

                    if (state.layout === 'horizontal') {
                        // --- Horizontal Grid Strategy ---
                        remainingCols = `
                            <div class="w-full text-right flex justify-end">
                                ${saveAmount > 0 ? saveBadgeHtml : ''}
                            </div>
                            <div class="flex flex-col items-end leading-none text-right">
                                <div class="text-[#004bc8] font-[800] text-[24px] tracking-tighter">RM${item.promo.toLocaleString('en-MY')}</div>
                                <div class="text-[#666] font-[600] text-[13px] mt-[2px]">SRP: RM${item.srp.toLocaleString('en-MY')}</div>
                            </div>
                        `;
                    } else {
                        // --- Stacked Grid Strategy ---
                        remainingCols = `
                            <div class="flex flex-col items-end justify-center text-right">
                                <div class="text-[#004bc8] font-[800] text-[24px] leading-none tracking-tighter">RM${item.promo.toLocaleString('en-MY')}</div>
                                <div class="text-[#666] font-[600] text-[13px] mt-[4px] leading-none">SRP: RM${item.srp.toLocaleString('en-MY')}</div>
                                ${saveAmount > 0 ? `<div class="mt-1.5 w-full flex justify-end">${saveBadgeHtml}</div>` : ''}
                            </div>
                        `;
                    }

                    li.innerHTML = nameCol + remainingCols;
                    list.appendChild(li);
                });
                container.appendChild(list);
            });
        }
    </script>
</body>

</html>
